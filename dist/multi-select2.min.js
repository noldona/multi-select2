/**
 * Multi-Select2.js
 *
 * Advanced multi-select control
 *
 * Based upon the Multi-Select2 library from Muhammad Abdullah <mabdullah5514@yahoo.com>
 * https://github.com/abdullah5514/multi-select2
 *
 * @authors Ron Jones <noldona@gmail.com>
 * @version 1.1.0
 * @license MIT <https://opensource.org/licenses/MIT>
 *
 * TODO: Make the control responsive
 */
const allowedAttributes={value:"data-value",disabled:"data-disabled",class:"class",type:"type",info:"data-info",action:"data-action",tabindex:"tabindex"};class MultiSelectElement{constructor(e,t={},s={}){return this._node=e instanceof HTMLElement?e:document.createElement(e),this._config={i18n:s},this._setAttributes(t),t.textContent&&(this._node.textContent=t.textContent),this}get(){return this._node}append(e){return this._node.appendChild(e),this}addClass(e){return this._node.classList.add(e),this}removeClass(e){return this._node.classList.remove(e),this}toggleClass(e){return this._node.classList.toggle(e),this}addEventListener(e,t,s=!1){return this._node.addEventListener(e,t,s),this}removeEventListener(e,t){return this._node.removeEventListener(e,t),this}setText(e){return this._node.textContent=e,this}getHeight(){return window.getComputedStyle(this._node).height}setTop(e){return this._node.style.top=`${e}px`,this}focus(){return this._node.focus(),this}_setAttributes(e){for(const t in e)allowedAttributes[t]&&e[t]&&this._setAttribute(allowedAttributes[t],e[t])}_setAttribute(e,t){this._node.setAttribute(e,t)}}class MultiSelect2{constructor(e,t){this._config={...t},this._state={opened:!1},this._icons=[],this.currentFocus=-1,this._boundHandleClick=this._handleClick.bind(this),this._boundHandleKeyUp=this._handleKeyUp.bind(this),this._boundHandleCloseClick=this._handleCloseClick.bind(this),this._boundPreventDefaultAction=this._preventDefaultAction.bind(this),this._boundUnselectOption=this._unselectOption.bind(this),this._boundSortOptions=this._sortOptions.bind(this),this._body=new MultiSelectElement(document.body),this._create(e),this._setValue()}_create(e){const t="string"==typeof e?document.querySelector(e):e;this._parent=new MultiSelectElement(t),this._select=new MultiSelectElement("div",{class:"multi-select__select",tabindex:"0"}),this._selected_value=new MultiSelectElement("span",{class:"multi-select__label"}),this._optionsDiv=new MultiSelectElement("div",{class:"multi-select__options"}),this._dropIcon=new MultiSelectElement("i",{class:"fa fa-caret-down multi-select__drop_icon"}),this._select.append(this._selected_value.get()),this._select.append(this._optionsDiv.get()),this._select.append(this._dropIcon.get()),this._parent.append(this._select.get()),this._options=this._generateOptionsOfSelect(),this._select.addEventListener("click",this._boundHandleClick,!0),this._select.addEventListener("keyup",this._boundHandleKeyUp),this._optionsDiv.addEventListener("keyup",this._boundHandleKeyUp,!0),this._body.addEventListener("keydown",this._boundPreventDefaultAction),document.addEventListener("click",this._boundHandleCloseClick,!0),this._config.multiple&&this._select.addClass("multi-select__select--multiple")}_generateOptionsOfSelect(){return this._config.autocomplete&&(this._autocomplete=new MultiSelectElement("input",{class:"multi-select__autocomplete",type:"text"}),this._autocomplete.addEventListener("input",this._boundSortOptions),this._optionsDiv.append(this._autocomplete.get())),this._config.options.map((e=>{let t="multi-select__option";e.class&&(t+=" "+e.class),e.groupHeader&&(t+=" multi-select__option--group_header");const s=new MultiSelectElement("div",{class:t,value:e.value,textContent:e.label,disabled:e.disabled,info:e.info,action:e.action,tabindex:"-1"});return this._optionsDiv.append(s.get()),s}))}_handleClick(e){e.stopPropagation(),this._closeAllLists(),"multi-select__autocomplete"!==e.target.className&&(this._state.opened?this._closeDropdown(!0,!0):"fa "+e.target.parentElement.classList[1]!==this._config.icon?"i"===e.target.tagName&&e.target.classList.contains(this._config.icon)?this._unselectOption(e.target.dataset.value):"svg"!==e.target.tagName?this._openDropdown():this._unselectOption(e.target.dataset.value):this._unselectOption(e.target.parentElement.dataset.value))}_handleCloseClick(){this._select.get().classList.contains("multi-select__select--opened")&&(event.stopPropagation(),this._closeDropdown(!1))}_handleKeyUp(e){e.preventDefault();let t=!1,s=!1,i=!1,n=!1,l=!1,o=!1,a=!1,c=!1,d=!1,_=!1,h=!1,r=!1,u=!1;if(void 0!==e.key)switch(e.key){case"Enter":t=!0,s=!0,i=!0,d=!0;break;case" ":case"Spacebar":t=!0,s=!0;break;case"Escape":case"Esc":case"Tab":t=!0,i=!0;break;case"ArrowDown":case"Down":t=!0,n=!0,a=!0;break;case"ArrowUp":case"Up":t=!0,n=!0,c=!0;break;case"ArrowLeft":case"Left":t=!0,h=!0,i=!0,_=!0;break;case"ArrowRight":case"Right":t=!0,r=!0,i=!0,_=!0;break;case"Delete":case"Del":case"Backspace":t=!0,u=!0,_=!0;break;case"Home":case"PageUp":t=!0,n=!0,l=!0,_=!0;break;case"End":case"PageDown":t=!0,n=!0,o=!0,_=!0}else if(void 0!==e.keyCode)switch(e.keyCode){case"Enter":t=!0,s=!0,i=!0,d=!0;break;case"Space":t=!0,s=!0;break;case"Escape":case"Tab":t=!0,i=!0;break;case"ArrowDown":t=!0,n=!0,a=!0;break;case"ArrowUp":t=!0,n=!0,c=!0;break;case"ArrowLeft":t=!0,h=!0,i=!0,_=!0;break;case"ArrowRight":t=!0,r=!0,i=!0,_=!0;break;case"Delete":t=!0,u=!0,_=!0;break;case"Home":case"PageUp":t=!0,n=!0,l=!0;break;case"End":case"PageDown":t=!0,n=!0,o=!0}if(t){if(e.stopPropagation(),this._closeAllLists(),this._state.opened&&i)return void this._closeDropdown(!0,d);if(s&&this._openDropdown(),this._state.opened&&n)if(a){let e=document.activeElement.nextSibling;for(;e;){if(!(e.classList.contains("multi-select__option--selected")||e.classList.contains("multi-select__option--hidden")||e.classList.contains("multi-select__option--group_header")||e.dataset.disabled)){e.focus();break}e=e.nextSibling}}else if(c){let e=document.activeElement.previousSibling;for(;e;){if(!(e.classList.contains("multi-select__option--selected")||e.classList.contains("multi-select__option--hidden")||e.classList.contains("multi-select__option--group_header")||e.dataset.disabled)){e.focus();break}e=e.previousSibling}}else if(o){let e=this._optionsDiv.get().lastElementChild;for(;e;){if(!(e.classList.contains("multi-select__option--selected")||e.classList.contains("multi-select__option--hidden")||e.classList.contains("multi-select__option--group_header")||e.dataset.disabled)){e.focus();break}e=e.previousSibling}}else if(l){let e=this._optionsDiv.get().firstElementChild;for(;e;){if(!(e.classList.contains("multi-select__option--selected")||e.classList.contains("multi-select__option--hidden")||e.classList.contains("multi-select__option--group_header")||e.dataset.disabled)){e.focus();break}e=e.nextSibling}}this._config.multiple&&(!this._state.opened&&_||h||r)&&(this._selected_value.get().contains(document.activeElement)?r?document.activeElement.nextSibling&&document.activeElement.nextSibling.focus():h?document.activeElement.previousSibling&&document.activeElement.previousSibling.focus():o?this._selected_value.get().lastElementChild.focus():l?this._selected_value.get().firstElementChild.focus():u&&(this._unselectOption(e.target.querySelector("[data-value]").dataset.value),this._select.get().focus()):r?(this._state.opened&&this._closeDropdown(),this._selected_value.get().hasChildNodes()&&this._selected_value.get().firstElementChild.focus()):h&&(this._state.opened&&this._closeDropdown(),this._selected_value.get().hasChildNodes()&&this._selected_value.get().lastElementChild.focus()))}}_openDropdown(){this._select.addClass("multi-select__select--opened"),this._state.opened=!0,this._autocomplete?this._autocomplete.focus():this._optionsDiv.get().firstElementChild.focus()}_closeDropdown(e=!0,t=!0){if(t){const e=this._options.find((e=>e.get()===event.target));if(e){if(e.get().dataset.disabled)return;this._setValue(e.get().dataset.value,!0)}}this._select.removeClass("multi-select__select--opened"),e&&this._select.get().focus(),this._state.opened=!1}_preventDefaultAction(e){if(document.activeElement==this._select.get()||this._select.get().contains(document.activeElement)){if("Tab"==e.key||"Tab"==e.keyCode){if(this._state.opened){if(this._config.tabSelect){const t=this._options.find((t=>t.get()===e.target));if(t){if(t.get().dataset.disabled)return;this._setValue(t.get().dataset.value,!0)}}this._closeDropdown()}return}let t=["Enter"," ","Spacebar","Escape","Esc","ArrowDown","Down","ArrowUp","Up","ArrowLeft","Left","ArrowRight","Right","Delete","Del","Backspace","Home","PageUp","End","PageDown"];this._config.autocomplete&&document.activeElement==this._autocomplete.get()||!t.includes(e.key)||(e.preventDefault(),e.stopPropagation())}}_setValue(e,t,s){if(this._config.autocomplete&&(this._autocomplete.get().value="",this._removeAllHiddenClass()),e&&!s&&(this._config.value=this._config.multiple?this._config.value.concat(e):e),e&&s&&(this._config.value=e),this._options.forEach((e=>{e.removeClass("multi-select__option--selected")})),this._config.multiple){const e=this._config.value.map((e=>{const t=this._config.options.find((t=>t.value===e));return this._options.find((e=>e.get().dataset.value===t.value.toString())).addClass("multi-select__option--selected"),t}));return void this._selectOptions(e,t)}if(!this._config.options.length)return;const i=this._config.value?this._config.options.find((e=>e.value.toString()===this._config.value)):"";if(""!==i){this._options.find((e=>e.get().dataset.value===i.value.toString())).addClass("multi-select__option--selected"),this._selectOption(i,t)}}_selectOption(e,t){this._selectedOption=e,this._selected_value.setText(e.label),this._config.onChange&&t&&this._config.onChange(e.value)}_selectOptions(e,t){this._selected_value.setText(""),this._icons=e.map((e=>{const t=new MultiSelectElement("span",{class:"multi-select__selected-label ".concat(e.class?e.class:""),textContent:e.label,tabindex:"-1"}),s=new MultiSelectElement("i",{class:this._config.icon,value:e.value});return t.append(s.get()),this._selected_value.append(t.get()),s.get()})),t&&this._optionsDiv.setTop(Number(this._select.getHeight().split("px")[0])),this._config.onChange&&t&&this._config.onChange(this._config.value)}_unselectOption(e){const t=[...this._config.value];let s;s=e.target?t.indexOf(e.target.dataset.value):t.indexOf(e),-1!==s&&t.splice(s,1),this._setValue(t,!0,!0)}_sortOptions(e){this._options.forEach((t=>{t.get().textContent.toLowerCase().includes(e.target.value.toLowerCase())||t.get().classList.contains("multi-select__option--group_header")?t.removeClass("multi-select__option--hidden"):t.addClass("multi-select__option--hidden")}))}_removeAllHiddenClass(){this._options.forEach((e=>{e.removeClass("multi-select__option--hidden")}))}_closeAllLists(){let e=document.getElementsByClassName("multi-select__select");for(let t=0;t<e.length;t++)e[t]!==this._select.get()&&e[t].classList.contains("multi-select__select--opened")&&e[t].classList.remove("multi-select__select--opened")}}